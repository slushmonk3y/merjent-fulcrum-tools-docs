<!-- start:source.tmpl.hbs -->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
		<title>Mtools/FulcrumHelpers.js</title>
		<!--[if lt IE 9]>
		<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<link href="https://fonts.googleapis.com/css?family=PT+Mono" rel="stylesheet">
		<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="css/prism.min.css">
		<link type="text/css" rel="stylesheet" href="css/template.min.css">
		<script type="text/javascript">
			window.TEMPLATE_OPTIONS = {"includeDate":true,"dateFormat":"Do MMM YYYY","systemName":"Merjent Fulcrum Tools","systemSummary":"Version 0.5.6","systemLogo":"","systemColor":"","navMembers":[{"kind":"module","title":"Modules","summary":"All documented modules."},{"kind":"class","title":"Classes","summary":"All documented classes. View inheritance chains in each class description."},{"kind":"external","title":"Externals","summary":"All documented external members."},{"kind":"global","title":"Globals","summary":"All documented globals."},{"kind":"mixin","title":"Mixins","summary":"All documented mixins."},{"kind":"interface","title":"Interfaces","summary":"All documented interfaces."},{"kind":"namespace","title":"Namespaces","summary":"All documented namespaces."},{"kind":"tutorial","title":"Tutorials","summary":"All available tutorials."}],"footer":"","copyright":"Mtools Copyright © 2025 Mikel Paiva","linenums":true,"collapseSymbols":true,"inverseNav":true,"inlineNav":false,"outputSourceFiles":false,"sourceRootPath":null,"disablePackagePath":true,"outputSourcePath":false,"showTableOfContents":true,"showAccessFilter":true,"analytics":null,"methodHeadingReturns":true,"sort":"lineage, longname","search":true,"favicon":null,"stylesheets":[],"scripts":[],"monospaceLinks":false,"cleverLinks":true,"default":{"outputSourceFiles":false}};
			window.DOCLET_TOC_ENABLED = false;
			window.DOCLET_AFILTER_ENABLED = false;
		</script>
</head>
<body>
	<!-- start:navbar.hbs -->
	<header class="navbar navbar-default navbar-fixed-top navbar-inverse">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">
					Merjent Fulcrum Tools
				</a>
				<!-- displayed on small devices -->
				<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="navbar-collapse collapse" id="topNavigation">
				<ul class="nav navbar-nav">
								<li class="dropdown">
									<a href="list_class.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="DataEventHelpers.html">DataEventHelpers</a></li>
											<li><a href="FieldHelpers.html">FieldHelpers</a></li>
											<li><a href="FieldHelpers.Mfld.html">FieldHelpers.Mfld</a></li>
											<li><a href="FieldHelpers.MfldColl.html">FieldHelpers.MfldColl</a></li>
											<li><a href="FulcrumHelpers.html">FulcrumHelpers</a></li>
											<li><a href="MerjentApp.html">MerjentApp</a></li>
											<li><a href="MLoadRecords.html">MLoadRecords</a></li>
											<li><a href="PhotoDirHandler.html">PhotoDirHandler</a></li>
											<li><a href="ReportHelpers.html">ReportHelpers</a></li>
											<li><a href="ReportHelpers.SecOpt.html">ReportHelpers.SecOpt</a></li>
											<li><a href="RequestHelpers.html">RequestHelpers</a></li>
											<li><a href="Utils.html">Utils</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_module.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="module-MtoolsDataEvents.html">MtoolsDataEvents</a></li>
											<li><a href="module-MtoolsMerjentApp.html">MtoolsMerjentApp</a></li>
											<li><a href="module-MtoolsReports.html">MtoolsReports</a></li>
											<li><a href="module-MtoolsUtils.html">MtoolsUtils</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_namespace.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="DefaultTemplate.html">DefaultTemplate</a></li>
											<li><a href="LockingMixins.html">LockingMixins</a></li>
											<li><a href="PermissionMixins.html">PermissionMixins</a></li>
											<li><a href="PhotoMixins.html">PhotoMixins</a></li>
											<li><a href="StatusMixins.html">StatusMixins</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_tutorial.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="tutorial-CHANGELOG.html">CHANGELOG</a></li>
											<li><a href="tutorial-01_overview.html">01_overview</a></li>
											<li><a href="tutorial-02_5_mloadrecords.html">02_5_mloadrecords</a></li>
											<li><a href="tutorial-02_mtools.html">02_mtools</a></li>
											<li><a href="tutorial-03_mapp.html">03_mapp</a></li>
											<li><a href="tutorial-04_pdf-reports.html">04_pdf-reports</a></li>
											<li><a href="tutorial-06_merjent-dev.html">06_merjent-dev</a></li>
											<li><a href="tutorial-07_general-dev.html">07_general-dev</a></li>
									</ul>
								</li>
				</ul>
					<!-- start:lunr-search-navbar.hbs -->
					<form class="navbar-form navbar-right" role="search">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="Search" id="lunr-search-input">
							<div class="input-group-btn">
								<button class="btn btn-default" id="lunr-search-submit">
									<i class="glyphicon glyphicon-search"></i>
								</button>
							</div>
						</div>
					</form>
					<!-- start:lunr-search-navbar.hbs -->		</div>
		</div>
	</header>
	<!-- end:navbar.hbs -->		<div class="page-header">
			<div class="container">
				<span class="kind">source</span>
				<h1><span class="name">Mtools/FulcrumHelpers.js</span></h1>
			</div>
		</div>
	<div class="container content">
		<div class="row">
			<div class="col-md-12 main-content">
		<section class="source-section">
			<article></article>
			<pre class="prettyprint source language-javascript line-numbers"><code class="language-javascript">import { Utils } from './Utils';
//#region *****************************  FULCRUM DATA EVENT HELPERS **********************************/
/**
 * @class FulcrumHelpers
 * @extends Utils
 * @summary Helper methods specific to Fulcrum
 * @description The methods in this class use Fulcrum expressions to complete common sets of actions used in Merjent Fulcrum Apps.
 *
 * **Inheritance:** Utils → **FulcrumHelpers**
 *
 * **Extended by:** {@link RequestHelpers}, {@link FieldHelpers}
 *
 * **Inherited Methods:** All {@link Utils} methods are available via inheritance.
 * Refer to the {@link Utils} class documentation for utility methods like `isBlank()`, `arrSort()`, `dt2iso()`, etc.
 *
 * **Methods Defined in This Class:** Only methods specific to Fulcrum operations are documented below.
 */
class FulcrumHelpers extends Utils{
  constructor(){
    super();
  }

  // getUserInit = this.userInit
  // setLatLon = this.popLatLon
  // check4PhotoCaps = this.photoCheck4Caps
  // checkPhotoCapLen = this.photoCheckCapLen
  // getFldSummaryObj = this.makeDnsRow
  // rep2Obj = this.makeRepRows
  // obj2Summary = this.rows2Summary
  // convertFV2DN = this.fv2DnRows

  /**
   * @summary *Developer Unhide*
   * @description Sets all fields visible if USERROLE() == 'Owner'
   *
   * @param {*} event 
   * @returns {void} 
   */
  devUnhide(event){
    const dns = DATANAMES();
    return ISROLE('Owner') ? 
      dns.forEach(dn => SETHIDDEN(dn, false)) : null;
  }

  /**
   * @summary *Developer Edit*
   * @description Sets all fields editable if USERROLE() == 'Owner'
   *
   * @param {*} event 
   * @returns {void} 
   */
  devEdit(event){
    const dns = DATANAMES();    
    return ISROLE('Owner') ?
      dns.forEach(dn => SETREADONLY(dn, false)) : null;
  }
  
  /**
   * @summary *Set All Read-only*
   * @description Sets all fields to readonly or editable or default, except those in the exclude list or not in the section if specified.
   *
   * @param {boolean} [bol=false] - Set field to readonly, null sets to default.
   * @param {string[]} [exc] - Array of datanames to exclude
   * @param {string} [sec=''] - Restrict function to only data names in this section
   * @returns {void}
   */
  setAllRO(bol = false, exc, sec = ''){
    var excludeFlds = exc ? exc : [];
    var dns = sec ? FIELDNAMES(sec) : DATANAMES();
    for(const dn of dns) {
      if (!excludeFlds.includes(dn)) {
        SETREADONLY(dn, bol);
      }
    };
  }

  /**
   * @description Checks if current user email ends in'merjent.com'
   * 
   * @returns {boolean}
   */
  isMerjentEmail(){
    var email = EMAIL()
    const dom = Utils.strAfter(email,'@')
    return dom == 'merjent.com' ? true : false
  }

  /** 
   * @description Disable editing location 
   * 
   * @param {*} event 
   * @returns {void}
  */
  disableLocationEdit(event){
    var config = {
      auto_location_enabled: false,
      auto_location_minimum_accuracy: 10,
      manual_location_enabled: false,
      edit_locations_enabled: false,
      edit_durations_enabled: false
    };
    SETFORMATTRIBUTES(config);
  }

  /**
   * @summary *User Initials*
   * @description Gets current users initials
   *
   * @returns {string} 
   */
  userInit(){
    var names = USERFULLNAME().split(' ');
    var inits = names.map(x => x.substring(0, 1).toUpperCase());
    return inits.join('');
  }

  /**
   * @summary *Get Report ID Variables*
   * @description Get information pieces used to build report id
   *
   * @param {string} [reportDate=null] 
   * @returns {{ yr: string, month: string, day: string, hr: string, min: string, init: string, report_yr: string, report_month: string, report_day: string}} 
   */
  getReportIDvars(reportDate=null){
    const dt = reportDate || new Date();
    const yr = dt.getFullYear().toString();
    const month = this.padZero(dt.getMonth() + 1, 2);
    const day = this.padZero(dt.getDate(), 2);
    const hr = this.padZero(dt.getHours(), 2);
    const min = this.padZero(dt.getMinutes(), 2);
    const init = this.userInit();

    return {"yr":yr,"month":month,"day":day,"hr":hr,"min":min,"init":init}
  }

  /**
   * @summary Require photo to be taken landscape
   * @description Validation for photo orientation, must be called from an ONCHANGE event of a photo field.
   *
   * @param {*} event 
   * @returns {boolean}
   */
  photoLandscape(event){
    if (event.value.width &lt; event.value.height) {
      INVALID('Please retake the photo in landscape orientation.');
      return false
    } else {return true}
  }

  /**
   * @summary *Photo Set Location*
   * @description Sets record location to the location of the first photo taken
   *
   * @param {*} event 
   * @returns {void}
   */
  photoSetLoc(event){
    var dn = event.field;
    if (!VALUE(dn)) {
      var lat = event.value.latitude;
      var lon = event.value.longitude;
      SETLOCATION(lat, lon);
      //ALERT("Record Location Set to: " + lat.toString() + lon.toString())
    }
  }

  /**
   * @summary *Clear Record-Link Auto-populates*
   * @description If the value of the record-link field is null, on change, this data event will clear all of the auto-populate fields. 
   * @param {*} event 
   * @returns {void}
   * @example ON('change', 'project_name', clearRLAutoPops)
   */
  clearRLAutoPops(event){
    if(event.value &amp;&amp; event.value.length > 0) return

    const fvDict = this.flipKVpair(this.makeFvDict(FORM()))
    const fld = FIELD(event.field)
    const defaults = fld.record_defaults
    const keys = defaults.map(x=>x.destination_field_key)
    const dns = keys.map(x => fvDict[x])

    dns.forEach((x) => this.clear(x))
  }

  /**
   * @summary *Populate Latitude Longitude*
   * @description For use in data event.
   * Sets value of {data_name} to current lat/lon as a string "lat,lon". 
   * Alerts if no GPS info.
   *
   * @param {string} [dn=null] - output field data name to write to
   * @returns {string}
   */
  popLatLon(dn){
    var loc = CURRENTLOCATION()
    if(loc){
      var output = loc.latitude + ',' + loc.longitude
      if(dn){
        SETVALUE(dn,output)
      }
      return output
    } else {
      ALERT('No GPS information available')
    }
  }

  /**
   * @summary *Photo Check for Captions*
   * @description Checks photofield for photos without a caption. Returns an Alert.
   *
   * @param {string} dn 
   * @returns {boolean}
   */
  photoCheck4Caps(dn) {
    const photos = VALUE(dn) || [];
    const captions = photos.map(x => x.caption);
    for (const caption of captions) {
      if (!caption) {
        ALERT('This report contains photos without a caption');
        return false;
      }
    }
    return true;
  }

  /**
   * @summary *Photo Check Caption Length*
   * @description Description placeholder
   *
   * @param {string} dn 
   * @param {number} max 
   * @returns {void}
   */
  photoCheckCapLen(dn,max){
    var photos = VALUE(dn)
    for(const photo of photos){
      if(photo &amp;&amp; photo.caption &amp;&amp; photo.caption.length > max){
        ALERT(`Photo caption ${max}`)
      }
    }
  }
  
  /**
   * @summary *Make data_names Row*
   * @description Creates an object from a list of data names. Excludes Labels, Sections and HyperlinkFields.
   *
   * @param {*} dns 
   * @param {Array.&lt;string>} [exc=[]] 
   * @returns {{}}
   * @todo dns2Row 
   */
  makeDnsRow(dns,exc=[]){
    var excludeFldTypes = ['Label','Section','HyperlinkField'];
    var dnsF = dns.filter((x) => !excludeFldTypes.includes(FIELDTYPE(x))).filter((x) => !exc.includes(x)); 
    var obj = {};
    for(const dn of dnsF){
      var val = VALUE(dn)
      FIELDTYPE(dn) == 'ChoiceField' || FIELDTYPE(dn) == 'ClassificationField' ? obj[dn] = CHOICEVALUES(val) :
        FIELDTYPE(dn) != 'ChoiceField' &amp;&amp; FIELDTYPE(dn) != 'ClassificationField' ? obj[dn] = val :
          FIELDTYPE(dn) == 'DateTimeField' ? obj[dn] =  Utils.dt2iso(val) :
            FIELDTYPE(dn) == 'Repeatable' ? obj[dn] = this.makeRepRows(dn,exc) : obj[dn] = JSON.stringify(val)
    }
    return obj
  }
  
  /**
   * @summary *Make Repeatable Rows*
   * @description Converts a repeatable to an Array of Objects.
   * Input repeatable data name.
   *
   * @param {string} repeatableDn 
   * @param {string[]} [exc=[]] 
   * @returns {Object[]} 
   * @todo rep2Rows
   */
  makeRepRows(repeatableDn,exc=[]){
    var repeatable = VALUE(repeatableDn);
    var excludeFldTypes = ['Label','Section','Repeatable','HyperlinkField'];
    var dns = FIELDNAMES(repeatableDn).filter((x) => !excludeFldTypes.includes(FIELDTYPE(x))).filter((x) => !exc.includes(x)); 
    var rows = [];
  
    if(VALUE(repeatableDn)){
      for(var i = 0; i &lt; repeatable.length; i++){
        var obj = {}
        obj["itemNo"] = i+1
        for(const dn of dns){
          var val = REPEATABLEVALUES(repeatable,dn)[i]
          FIELDTYPE(dn) == 'ChoiceField' || FIELDTYPE(dn) == 'ClassificationField' ? obj[dn] = CHOICEVALUES(val) :
            FIELDTYPE(dn) != 'ChoiceField' &amp;&amp; FIELDTYPE(dn) != 'ClassificationField' ? obj[dn] = val :
              FIELDTYPE(dn) == 'DateTimeField' ? obj[dn] =  Utils.dt2iso(val) : obj[dn] = JSON.stringify(val)
        }
        rows.push(obj)
      }
    }
    return rows
  }

  /**
   * @summary *Rows to Summary*
   * @description Converts an array of objects to an array of summary strings, excluding specified keys.
   * Each summary string lists key-value pairs separated by commas.
   * @param {Object[]} rows - Array of objects to summarize.
   * @param {string[]} [exc=[]] - Array of keys to exclude from summary.
   * @returns {string[]}
   */
  rows2Summary(rows, exc = []) {
    const outList = [];
    for (const row of rows) {
      let line = '';
      const keys = Object.keys(row).filter(key => !exc.includes(key));
      for (const key of keys) {
        line += `${key}: ${row[key]},`;
      }
      outList.push(line);
    }
    return outList;
  }

  /**
   * @summary *Form Values to Data Names Rows*
   * @description Converts an array of Fulcrum rows to an array of objects with data names as keys.
   * Uses a dictionary to map form_value keys to data names.
   * @param {Object[]} rows - Array of Fulcrum record objects.
   * @param {Object} dict - Dictionary mapping form_value keys to data names.
   * @returns {Object[]} - Array of objects with mapped keys and values.
   */
  fv2DnRows(rows, dict) {
    const output = [];
    for (const row of rows) {
      const newRow = {};
      newRow.status = row.status;
      newRow.id = row.id;
      newRow.latitude = row.latitude;
      newRow.longitude = row.longitude;
      newRow.geometry = row.geometry;
      const keys = Object.keys(row.form_values);
      for (const key of keys) {
        newRow[dict[key]] = row.form_values[key];
      }
      output.push(newRow);
    }
    return output;
  }

  /**
   * @summary *Load Records*
   * @description Wrapper function for LOADRECORDS() expression.
   *
   * @param {Array.&lt;string>} arr 
   * @param {string} formID 
   * @param {Function} callback - function to process records and store them to a variable or field. Callback must have one parameter for records. See example.
   * @return {void}
   * @example
   * processRecordsCallback(records){
   *   loadedRecords = convertFV2DN(records,loadedFvs)
   *   var out = []
   *   for(const record of loadedRecords){
   *     var add = record.scientific_name + ' - ' + record.common_name
   *     out.push(add)
   *   }
   *   SETVALUE('result',out.join('\n'))
   * }
   * 
   * M.loadRecords(recIDs,appID,processRecordsCallback)
   * 
   */
  loadRecords(arr,formID,callback){
    const opts = !arr ? {'form_id':formID} : {'ids':arr,'form_id':formID};
    const pullRecords = (err,r)=>{
      if(err){ALERT('LOADRECORDS failed:' + JSON.stringify(err));}else{callback(r.records)}
    }
    LOADRECORDS(opts,pullRecords);
  }

  /**
   * @summary *Get Repeatable Parent*
   * @description get parent data_name for a field. Returns only the next parent that is a repeatable.
   * @param {string} dn 
   * @returns {string} - data_name of the parent (repeatable or section) of a field. If there is no parent, it returns null.
   * @example getRepDn('inspector_name') // returns 'background'
   * @todo repParent? digParent? - make generic recursion function that produces row of all parents and parent types. For repeatables, secctions or elements of form schema.
   */
  getRepDn(dn = '') {
    var obj = FIELD(dn);
    var output = null;
    if(!obj){return output}
    function traverseObject(obj) {
      if (obj.hasOwnProperty('parent') &amp;&amp; obj.parent.type == 'Repeatable') {
        output = obj.parent.data_name;
        return;
      }
      else if (obj.hasOwnProperty('parent') &amp;&amp; obj.parent.type === 'Section') {
        traverseObject(obj.parent); // Recursively traverse nested objects
      }
      else {
        return;
      }
    }
    traverseObject(obj);
    return output;
  };

  // /**
  //  * Recursively collects all leaf elements from a Fulcrum form schema.
  //  * @param {Object} parent - The parent element to start from.
  //  * @param {Array} collector - The array to collect elements into.
  //  * @todo digObj - REMOVE this and extractFormElements. Use makeFvDict keys instead.
  //  */
  // digElements(parent, collector) {
  //   if (parent.elements &amp;&amp; Array.isArray(parent.elements)) {
  //     for (const subElement of parent.elements) {
  //       this.digElements(subElement, collector);
  //     }
  //   } else if (parent) {
  //     collector.push(parent);
  //   }
  // }
  
  // /**
  //  * @description Input a fulcrum form schema Object and returns a dictionary object of {data_name:form_value}.
  //  *
  //  * @param {Object} form - Fulcrum form schema object.
  //  * @returns {Array} - Array of leaf elements.
  //  * @todo WRONG remove
  //  */
  // extractFormElements(form) {
  //   const output = [];
  //   if (form &amp;&amp; form.elements) {
  //     for (const element of form.elements) {
  //       this.digElements(element, output);
  //     }
  //   }
  //   return output;
  // }

  /**
   * @summary *Dig Element*
   * @description Recursively collects all data_name:form_value pairs from element. Adds element to collector array.
   * Primarily used as a sub-function within makeFvDict.
   * @param {Object} el - The parent element to start from.
   * @param {object} collector - The object to collect elements into.
   * @returns {void} - Adds element to collector array
   */
  digElement(el,collector){
    if (!el) return;
    if (el.data_name &amp;&amp; el.key) collector[el.data_name] = el.key;
    if (Array.isArray(el.elements)) {
      for (const subel of el.elements) {
        if (!subel) continue;
        this.digElement(subel, collector);
      }
    }
  }

  /**
   * @summary *Make Form Values Dictionary*
   * @description Input a fulcrum form schema Object and returns a dictionary object of {data_name:form_value}.
   *
   * @param {Object} form - Fulcrum form schema object.
   * @returns {{}} - Dictionary of {data_name:form_value}.
   */
  makeFvDict(form) {
    var out = {}
    if (form &amp;&amp; form.elements) {
      for (const el of form.elements) {
        this.digElement(el, out);
      }
    }
    return out;
  }
  
  /**
   * @description Description placeholder
   *
   * @param {string} formID - fulcrum form id
   * @param {Function} callback - function to process form schema
   * @returns {void}
   * 
   * @example 
   *  processFormCallback(form){
   *     loadedFvs = M.flipKVpair(this.makeFvDict(form))
   *  }
   * 
   * M.loadForm(formID,processFormCallback)
   */
  loadForm(formID,callback){
    LOADFORM(
      {id:formID},
      (err,r)=>{if(err){ALERT('LOADFORM failed:' + JSON.stringify(err))}else{callback(r.form)}}
    )
  }

  /**
   * @summary *Each Section Data Name*
   * @description Performs callback function on each data name in a section.
   *
   * @param {string} secDn - Section data name.
   * @param {Function} callback - Function to perform for each data name.
   * @returns {void}
   */
  eachSecDn(secDn,callback,exc=[]){
    if(FIELDNAMES(secDn)){
      var dns = FIELDNAMES(secDn)
      for(const dn of dns){
        if(!exc.includes(dn)){
          callback(dn)
        }
      }
    }
  }

  /**
   * @description Clears value in fulcrum field.
   *
   * @param {string} dn - Data name to clear.
   * @returns {void}
   */
  clear(dn){
    if(VALUE(dn)){
      SETVALUE(dn,null)
    }
  }

  /**
   * @description Description placeholder
   *
   * @param {*} repVals - this is from VALUE(repeatable data name)
   * @param {string} dnFv 
   * @returns {{}} 
   */
  getRepeatableValues(repVals,dnFv){ 
    var out =[]
    for(const row of repVals){
      var formVals = row.form_values
      var dnVal = {}
      
      Object.keys(formVals).forEach(function(fv){
        dnVal[dnFv[fv]] = formVals[fv] || null
      })
      out.push(dnVal)
    }
    return out
  }/** @description Description placeholder */
  ;
    
  /**
   * @description Description placeholder
   *
   * @param {string} parentDn 
   * @param {string} childDn 
   * @param {string} dnFv 
   * @returns {{}} 
   * @todo deprecate or add recursion
   */
  getNestedRepeatable(parentDn,childDn,dnFv){
    var outputList = []
    var parentRep = VALUE(parentDn)
    if(parentRep){
      for(var i = 0; i &lt; parentRep.length; i++){
        var output = {}
        var childRep = parentRep[i].form_values[dnFv[childDn]] || null
        if(childRep){
          output.task = parentRep[i].form_values[dnFv.task].choice_values[0] || null
          output.subtask = parentRep[i].form_values[dnFv.subtask].choice_values[0] || null
          output[childDn] = this.getRepeatableValues(childRep)
          outputList.push(output)
        }
      }
    }
    return outputList
  }

  /**
   * @summary *Timed Processing Message*
   * @description block input into form with an alert message for a set time in milliseconds.
   *
   * @param {number} time - milliseconds for settimeout
   * @returns {void}
   * @todo add example
   */
  timedProcessingMsg(time){
    var showAlert = true
    var msgOpts = {title:'Standby',message:'Requesting Data...',buttons:['ok']}
    var turnOff = function(result){
      if(showAlert){
        MESSAGEBOX(msgOpts,turnOff);
      } else{ }
    }
    SETTIMEOUT(function(){showAlert=false},time)
    MESSAGEBOX(msgOpts,turnOff);
  }
  
  /**
   * @summary *Value Processing Message*
   * @description block input into form with an alert message until a value is present in the specified data name or until a settimeout.
   *
   * @param {string} dn 
   * @param {number} time - milliseconds for settimeout
   * @returns {void}
   * @tod add example
   */
  valProcessingMsg(dn,time,isBlank=Utils.isBlank){
    SETVALUE(dn,null)
    var showAlert = true
    var msgOpts = {title:'Standby',message:'Requesting Data...',buttons:['ok']}
    var turnOff = function(result){
      if(isBlank(dn) &amp;&amp; showAlert){
        MESSAGEBOX(msgOpts,turnOff);
      } 
      if(isBlank(dn) &amp;&amp; !showAlert){
        msgOpts.message='TIMEOUT: Unable to retrieve data within ' + time.toString + ' milliseconds'
        MESSAGEBOX(msgOpts,turnOff);
      } else{}
    }
    SETTIMEOUT(function(){showAlert=false},time)
    MESSAGEBOX(msgOpts,turnOff);
  }


  /**
   * Factory method for PhotoDirHandler (backward compatibility)
   * @param {string} photoFldDn - Photo field data name
   * @param {string} [photoDirDn=""] - Direction field data name (degrees)
   * @param {string} [photoCardDn=""] - Cardinal direction field data name
   * @param {boolean} [secondary=false] - Use 16-point compass if true, 8-point if false
   * @returns {PhotoDirHandler} PhotoDirHandler instance
   * @example
   * const photoDirObj = M.mkPhotoDirHandler('photo_field', 'direction_deg', 'direction_cardinal')
   * function changeDir(event){
   *   photoDirObj.popOther(event)
   * }
   * ON('change', photoDirObj.dnDir, changeDir)
   * ON('change', photoDirObj.dnCard, changeDir)
   * ON('add-photo', photoDirObj.photoDn, photoDirObj.extractPhotoDir)
   */
  mkPhotoDirHandler(photoFldDn, photoDirDn = "", photoCardDn = "", secondary = false) {
    return new PhotoDirHandler(photoFldDn, photoDirDn, photoCardDn, secondary);
  }

  /**
   * Factory method for MLoadRecords (backward compatibility)
   * @param {string} formID - Fulcrum form ID
   * @param {Function} enterLoadedData - Callback function to process loaded records
   * @param {FulcrumHelpers} [fulcrumHelpers=this] - Optional helper instance (defaults to current FulcrumHelpers instance)
   * @returns {MLoadRecords} MLoadRecords instance
   * @example
   * const appID = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
   *
   * function processRecords() {
   *   const loadedRecords = loader.appRecords
   *   const titleList = loadedRecords.map(x => x.scientific_name + ' - ' + x.common_name)
   *   SETVALUE('result', titleList.join('\n'))
   * }
   *
   * const loader = M.mkMLoadRecords(appID, processRecords)
   *
   * ON('load-record', loader.getAppFvs)
   * ON('change', 'species_link', loader.loadRecords)
   */
  mkMLoadRecords(formID, enterLoadedData, fulcrumHelpers = this) {
    return new MLoadRecords(formID, enterLoadedData, fulcrumHelpers);
  }

}
//#endregion

/**
 * @summary Handles photo direction field synchronization
 * @description Synchronizes photo direction fields between degrees and cardinal directions.
 * Automatically populates direction fields from photo metadata and keeps degree/cardinal fields in sync.
 *
 * @property {string} photoDn - Photo field data name
 * @property {string} dnDir - Direction field data name (degrees 0-360)
 * @property {string} dnCard - Cardinal direction field data name (N, NE, E, etc.)
 * @property {boolean} secondary - Use 16-point compass if true, 8-point if false
 *
 * @example
 * // Create handler
 * const photoDirObj = new PhotoDirHandler('site_photos', 'photo_direction_deg', 'photo_direction_card', false);
 *
 * // Set up event handlers
 * function changeDir(event) {
 *   photoDirObj.popOther(event);
 * }
 * ON('change', 'photo_direction_deg', changeDir);
 * ON('change', 'photo_direction_card', changeDir);
 * ON('add-photo', 'site_photos', photoDirObj.extractPhotoDir.bind(photoDirObj));
 *
 * @example
 * // Using factory method (backward compatible)
 * const photoDirObj = M.photoDirHandler('site_photos', 'photo_direction_deg', 'photo_direction_card');
 */
class PhotoDirHandler {
  /**
   * @param {string} photoFldDn - Photo field data name
   * @param {string} [photoDirDn=""] - Direction field data name (degrees)
   * @param {string} [photoCardDn=""] - Cardinal direction field data name
   * @param {boolean} [secondary=false] - Use 16-point compass if true, 8-point if false
   */
  constructor(photoFldDn, photoDirDn = "", photoCardDn = "", secondary = false) {
    this.photoDn = photoFldDn;
    this.dnDir = photoDirDn;
    this.dnCard = photoCardDn;
    this.secondary = secondary;
  }

  /**
   * Synchronize degree and cardinal direction fields
   * @param {Object} event - Fulcrum change event
   * @description When one field changes, updates the other to match.
   * Converts between degrees (0-360) and cardinal directions (N, NE, E, etc.)
   */
  popOther(event) {
    const dn = event.field;
    const val = !VALUE(dn) ? null
                  : VALUE(dn).choice_values &amp;&amp; VALUE(dn).choice_values.length > 0
                    ? VALUE(dn).choice_values[0]
                    : VALUE(dn).choice_values ? null
                      : VALUE(dn);

    if (!val) {
      if (dn === this.dnDir) return SETVALUE(this.dnCard, null);
      if (dn === this.dnCard) return SETVALUE(this.dnDir, null);
    }

    if (dn === this.dnDir) return SETVALUE(this.dnCard, Utils.deg2Dir(val, this.secondary));
    if (dn === this.dnCard) return SETVALUE(this.dnDir, Utils.dir2Deg(val, this.secondary));
  }

  /**
   * Extract direction from photo metadata
   * @param {Object} event - Fulcrum add-photo event
   * @description Automatically populates direction fields when a photo with direction metadata is added.
   */
  extractPhotoDir(event) {
    if (!event.value || !event.value.direction) return;
    const dir = event.value.direction;
    const card = Utils.deg2Dir(dir, this.secondary);
    SETVALUE(this.dnDir, dir);
    SETVALUE(this.dnCard, [card]);
  }
}

/**
 * @summary Loads and manages records from a linked Fulcrum form
 * @description Handles loading form schemas and records from companion Fulcrum apps.
 * Creates a dictionary to convert form_value keys to data_name keys for easier access.
 *
 * **Common use cases:**
 * - Load records from a linked app based on a record link field
 * - Refresh a record link field when records in the linked app reference this record
 * - Prevent duplicate record selection across records in this app
 *
 * @property {string} formID - Fulcrum form ID of the linked app
 * @property {Function|null} enterLoadedData - Callback to process records after loading
 * @property {Array&lt;string>|null} recIDs - Array of record IDs to load
 * @property {Object} appFvs - Dictionary mapping form_value keys to data_names
 * @property {Array&lt;Object>|null} appRecords - Loaded records with data_name keys
 * @property {boolean} recordsOnLoad - If true, loads records immediately after form schema
 * @property {Array&lt;Array>|null} sortOrder - Sort order for queries, e.g., [['report_id', 'dsc']]
 * @property {string} dnRecLink - Data name of record link field in this app
 * @property {string} dnRecLinkIds - Data name of text field storing record IDs
 * @property {Array&lt;string>} dnsRecLinkAuto - Data names to clear if duplicate found
 * @property {string} dnRefreshRL - Data name of record link field to refresh
 * @property {Function} addOnRefreshRL - Additional callback after refreshing record link
 * @property {Function} duplicateAlert - Function to call when duplicate detected
 * @property {FulcrumHelpers} helpers - FulcrumHelpers instance for utility methods
 *
 * @see FulcrumHelpers
 * @see FulcrumHelpers#loadRecords
 * @see FulcrumHelpers#fv2DnRows
 *
 * @example &lt;caption>Basic usage - load records on change&lt;/caption>
 * const appID = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
 *
 * function processRecordsCallback() {
 *   const loadedRecords = loader.appRecords
 *   const titleList = loadedRecords.map(x => x.scientific_name + ' - ' + x.common_name)
 *   SETVALUE('result', titleList.join('\n'))
 * }
 *
 * const loader = new MLoadRecords(appID, processRecordsCallback)
 * loader.dnRecLink = 'species_link'
 *
 * ON('load-record', loader.buildAppFvDict)
 * ON('change', 'species_link', loader.updateLoadedRecords)
 *
 * @example &lt;caption>Duplicate checking&lt;/caption>
 * const loader = new MLoadRecords(appID, null)
 * loader.dnRecLink = 'project_link'
 * loader.dnRecLinkIds = 'project_id_text'
 * loader.dnsRecLinkAuto = ['project_name', 'project_date']
 *
 * ON('load-record', loader.buildAppFvDict)
 * ON('change', 'project_link', loader.selfDupCheck)
 */
class MLoadRecords{
  /**
   * @summary Additional callback after refreshing record link
   * @description Override this to perform additional actions after refreshRecordLink completes.
   * @type {Function}
   * @example
   * loader.addOnRefreshRL = () => {
   *   SETVALUE('child_count', loader.appRecords.length)
   * }
   */
  addOnRefreshRL = () => { return null; };

  /**
   * @summary Alert function for duplicate detection
   * @description Override this to customize the duplicate record alert message.
   * @type {Function}
   * @example
   * loader.duplicateAlert = () => {
   *   ALERT('This project is already assigned to another record.')
   * }
   */
  duplicateAlert = () => { ALERT('Duplicate record selected. Please choose another record.'); };

  /**
   * @param {string} formID - Fulcrum form ID (required)
   * @param {Function} [enterLoadedData=null] - Callback function to process loaded records
   * @param {FulcrumHelpers} [fulcrumHelpers=null] - Optional helper instance (creates new FulcrumHelpers if not provided)
   * @throws {Error} If formID is not provided
   * @throws {Error} If enterLoadedData is provided but is not a function
   */
  constructor(formID, enterLoadedData = null, fulcrumHelpers = null){
    if (!formID) {
      throw new Error('MLoadRecords requires a formID');
    }
    if (enterLoadedData &amp;&amp; typeof enterLoadedData !== 'function') {
      throw new Error('enterLoadedData must be a function');
    }

    this.enterLoadedData = enterLoadedData;
    this.formID = formID;
    this.recIDs = null;
    this.recordsOnLoad = false;
    this.sortOrder = null; // e.g. [['report_id', 'dsc']]
    this.dnRecLink = ''; // THIS app data_name of record link field to base Loads on.
    this.dnRecLinkIds = '';// CHILD app data_name of text field, storing record ids to match against this.dnRecLink
    this.dnsRecLinkAuto = []; // THIS app data names to auto clear if duplicate found in selfDupCheck
    this.dnRefreshRL = ''; // CHILD app data_name of record link field to load/refresh this.dnRecLink in this app.
    this.appFvs = {};
    this.appRecords = [];
    this.helpers = (fulcrumHelpers instanceof FulcrumHelpers) ? fulcrumHelpers : new FulcrumHelpers();
  }

  /**
   * @summary Creates a filter object for loading all records from a form
   * @description Returns a query object with no predicates, which loads all records.
   * @returns {Object} Empty filter object with form_id
   * @example
   * const opts = loader.filterEmpty()
   * loader.loadRecords(opts, myCallback)
   */
  filterEmpty() {
    return { "form_id": this.formID, "where": { "operator": "or", "predicates": [] } };
  }

  /**
   * @summary Creates a filter object for loading records by ID array
   * @description Returns a query object that loads specific records by their IDs.
   * @param {Array&lt;string>} ids - Array of Fulcrum record IDs
   * @returns {Object} Filter object with ids and form_id
   * @example
   * const ids = ['abc-123', 'def-456']
   * const opts = loader.filterId(ids)
   * loader.loadRecords(opts, myCallback)
   */
  filterId(ids) {
    return { "ids": ids, "form_id": this.formID };
  }

  /**
   * @summary Creates a filter object with a single predicate
   * @description Returns a query object with a single field filter.
   * Common operators: "equal_to", "not_equal_to", "contains", "starts_with", "greater_than", "less_than"
   * @param {string} dn - Data name of field to filter on
   * @param {string} op - LOADRECORDS operator (e.g., "equal_to", "contains")
   * @param {string|number|boolean} val - Value to filter by
   * @param {Array&lt;Array>|null} [order=null] - Optional sort order, e.g., [['date', 'dsc']]
   * @returns {Object} Filter object for LOADRECORDS
   * @example
   * const opts = loader.filterTemplate('status', 'equal_to', 'active')
   * loader.loadRecords(opts, myCallback)
   * @example &lt;caption>With sort order&lt;/caption>
   * const opts = loader.filterTemplate('project_id', 'equal_to', 'P123', [['created_at', 'dsc']])
   */
  filterTemplate(dn, op, val, order = null) {
    return {
      "form_id": this.formID,
      "where": {
        "operator": "and",
        "predicates": [
          { "field": dn, "operator": op, "value": val }
        ]
      },
      "order": order || null
    };
  }

  /**
   * @summary Processes records and updates appRecords
   * @description Common logic for converting form_value keys to data_name keys.
   * Sets this.appRecords to null if no records, otherwise converts and stores them.
   * @param {Array&lt;Object>} records - Array of raw Fulcrum record objects
   * @returns {boolean} True if records were processed, false if empty/null
   * @private
   */
  _processRecordResults(records) {
    if (!records || records.length &lt; 1) {
      this.appRecords = null;
      return false;
    }
    this.appRecords = this.helpers.fv2DnRows(records, this.appFvs);
    return true;
  }

  /**
   * @summary Loads form schema
   * @description Loads a Fulcrum form schema and passes it to the callback.
   * Delegates to FulcrumHelpers.loadForm.
   * @param {string} formID - Fulcrum form ID to load
   * @param {Function} callBack - Function to receive the loaded form schema
   * @returns {void}
   */
  loadForm = (formID, callBack) => {
    this.helpers.loadForm(formID, callBack);
  }

  /**
   * @summary Loads records with flexible parameter handling
   * @description Wrapper for FulcrumHelpers.loadRecords with enhanced parameter handling.
   * Supports flexible parameter formats for convenience in MLoadRecords context.
   * @param {Object|Array&lt;string>|string|null} [opts=null] - Can be: null (loads all), array of IDs, query object, or formID string
   * @param {Function|null} [callback=null] - Callback function. Defaults to this.processRecords
   * @returns {void}
   * @example &lt;caption>Load by ID array&lt;/caption>
   * loader.loadRecords(['id1', 'id2'], myCallback)
   * @example &lt;caption>Load with query object&lt;/caption>
   * const opts = loader.filterTemplate('status', 'equal_to', 'active')
   * loader.loadRecords(opts)
   */
  loadRecords = (opts = null, callback = null) => {
    // Normalize opts to match FulcrumHelpers.loadRecords signature (arr, formID, callback)
    let arr = null;
    let formID = this.formID;

    if (Array.isArray(opts)) {
      arr = opts;
    } else if (typeof opts === 'object' &amp;&amp; opts !== null) {
      // It's already a query object, use advanced version
      callback = callback ? callback : this.processRecords;
      const pullRecords = (e, r) => {
        if (e) {
          ALERT('LOADRECORDS failed:' + JSON.stringify(e));
        } else {
          callback(r.records);
        }
      };
      LOADRECORDS(opts, pullRecords);
      return;
    } else if (typeof opts === 'string') {
      formID = opts;
    }

    // Use the helper method for simple cases
    callback = callback ? callback : this.processRecords;
    this.helpers.loadRecords(arr, formID, callback);
  }

  /**
   * @summary Loads form schema and immediately loads records
   * @description Use in ON('load-record') event. Sets recordsOnLoad=true,
   * then loads form schema and continues to load records.
   * Equivalent to setting recordsOnLoad=true and calling buildAppFvDict.
   * @param {Object} event - Fulcrum load-record event object
   * @returns {void}
   * @todo deprecate getAppFvs in favor of buildAppFvDict with recordsOnLoad = true
   * @example
   * ON('load-record', loader.getAppFvs)
   */
  getAppFvs = (event) => {
    this.recordsOnLoad = true;
    this.loadForm(this.formID, this.processForm);
  }

  /**
   * @summary Loads form schema only (no records)
   * @description Use in ON('load-record') event. Loads form schema to build
   * the form_value to data_name dictionary, but does NOT load any records.
   * Records can be loaded later via updateLoadedRecords or loadRecords.
   * @param {Object} event - Fulcrum load-record event object
   * @returns {void}
   * @example
   * ON('load-record', loader.buildAppFvDict)
   * ON('change', 'species_link', loader.updateLoadedRecords)
   */
  buildAppFvDict = (event) => {
    this.loadForm(this.formID, this.processForm);
  }

  /**
   * @summary Updates loaded records from record link field
   * @description Extracts record IDs from the configured record link field (dnRecLink)
   * and loads those records. Clears auto fields if no IDs found.
   * @param {Object} event - Fulcrum change event object
   * @returns {void}
   * @example
   * loader.dnRecLink = 'species_link'
   * ON('change', 'species_link', loader.updateLoadedRecords)
   */
  updateLoadedRecords = (event) => {
    const ids = VALUE(this.dnRecLink) ? VALUE(this.dnRecLink).map(x => x.record_id) : null;
    if (!ids || ids.length &lt; 1) return this.clearAutoFields();
    this.loadRecords(ids, this.processRecords);
  }

  /**
   * @summary Processes loaded form schema
   * @description Callback for loadForm. Creates the form_value to data_name dictionary (appFvs).
   * If recordsOnLoad is true, continues to load records via refreshRecordLink or updateLoadedRecords.
   * @param {Object} form - Fulcrum form schema object
   * @returns {void}
   */
  processForm = (form = null) => {
    if (form) {
      this.appFvs = this.helpers.flipKVpair(this.helpers.makeFvDict(form));
      if (this.recordsOnLoad &amp;&amp; this.dnRefreshRL) {
        this.refreshRecordLink();
      }
      if (this.recordsOnLoad &amp;&amp; !this.dnRefreshRL) {
        this.updateLoadedRecords();
      }
    }
  }

  /**
   * @summary Processes loaded records
   * @description Default callback for loadRecords. Converts form_value keys to data_name keys
   * and stores in appRecords. Calls enterLoadedData callback if recordsOnLoad is true.
   * @param {Array&lt;Object>} records - Array of raw Fulcrum record objects
   * @returns {void}
   */
  processRecords = (records) => {
    if (!this._processRecordResults(records)) return;
    if (this.recordsOnLoad &amp;&amp; this.enterLoadedData) this.enterLoadedData(records);
  }

  /**
   * @summary Checks for duplicate record selection
   * @description Prevents selecting a record that is already linked in another record of this app.
   * Queries for records containing the selected record ID and clears selection if found.
   * Requires dnRecLink, dnRecLinkIds, and optionally dnsRecLinkAuto to be configured.
   * @param {Object} event - Fulcrum change event from record link field
   * @returns {void}
   * @example
   * loader.dnRecLink = 'project_link'
   * loader.dnRecLinkIds = 'project_id_text'
   * loader.dnsRecLinkAuto = ['project_name', 'project_date']
   * ON('change', 'project_link', loader.selfDupCheck)
   */
  selfDupCheck = (event) => {
    const id = event.value &amp;&amp; event.value.length > 0 ? event.value[0].record_id : null;
    if (!id) return this.clearAutoFields();

    SETVALUE(this.dnRecLinkIds, id);
    const qOpts = this.filterTemplate(this.dnRecLinkIds, "contains", id);
    this.loadRecords(qOpts, this.processSelfDupCheck);
  }

  /**
   * @summary Processes duplicate check results
   * @description Callback for selfDupCheck. If records are found that aren't the current record,
   * clears the selection, auto fields, and shows the duplicate alert.
   * @param {Array&lt;Object>} records - Array of raw Fulcrum record objects
   * @returns {void}
   */
  processSelfDupCheck = (records) => {
    if (!this._processRecordResults(records)) return;

    const filteredIds = records.filter((x) => x.id == RECORDID());
    if (filteredIds.length > 0) return;

    if (this.dnsRecLinkAuto.length > 0) this.clearAutoFields();
    SETVALUE(this.dnRecLink, null);
    this.duplicateAlert();
  }

  /**
   * @summary Processes refresh record link results
   * @description Callback for refreshRecordLink. Updates the record link field
   * with the IDs of loaded records and calls addOnRefreshRL callback.
   * @param {Array&lt;Object>} records - Array of raw Fulcrum record objects
   * @returns {void}
   */
  processRefreshRL = (records) => {
    if (!this._processRecordResults(records)) return;

    const ids = this.appRecords.map(x => x.id);
    SETVALUE(this.dnRecLink, ids);
    this.addOnRefreshRL();
  }

  /**
   * @summary Refreshes a record link field with linked records
   * @description Queries for records in the linked app that reference the current record
   * (via dnRefreshRL field containing current RECORDID), then updates the record link field.
   * Requires dnRefreshRL to be configured.
   * @returns {void}
   * @example
   * loader.dnRefreshRL = 'parent_record_link'
   * loader.dnRecLink = 'child_records'
   * loader.sortOrder = [['created_at', 'dsc']]
   */
  refreshRecordLink = () => {
    const opts = this.filterTemplate(this.dnRefreshRL, "contains", RECORDID(), this.sortOrder);
    this.loadRecords(opts, this.processRefreshRL);
  }

  /**
   * @summary Clears auto-populated fields
   * @description Clears all fields listed in dnsRecLinkAuto array.
   * Called when record link is cleared or duplicate is detected.
   * @returns {void}
   */
  clearAutoFields = () => {
    if (this.dnsRecLinkAuto.length &lt; 1) return;

    for (const dn of this.dnsRecLinkAuto) {
      this.helpers.clear(dn);
    }
  }
}

export { FulcrumHelpers, MLoadRecords };
</code></pre>
		</section>
			</div>
		</div>
	</div>
	<footer>
				<div class="copyright">Mtools Copyright © 2025 Mikel Paiva</div>
			<div class="generated-by">Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on 22nd Jan 2026 using the <a href="https://github.com/steveush/foodoc">FooDoc template</a>.</div>
	</footer>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/clipboard.min.js"></script>
	<script src="js/prism.min.js"></script>
	<script src="js/template.min.js"></script>
		<!-- start:lunr-search-modal.hbs -->
		<div class="modal fade" id="lunr-search-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Search results</h4>
					</div>
					<div class="modal-body" id="lunr-search-body">
					</div>
					<div class="modal-footer" id="lunr-search-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div>
		<!-- end:lunr-search-modal.hbs -->		<script src="js/lunr.min.js"></script>
	
</body>
</html>
<!-- end:source.tmpl.hbs -->