<!-- start:source.tmpl.hbs -->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
		<title>Mtools/DataEventHelpers.js</title>
		<!--[if lt IE 9]>
		<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<link href="https://fonts.googleapis.com/css?family=PT+Mono" rel="stylesheet">
		<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="css/prism.min.css">
		<link type="text/css" rel="stylesheet" href="css/template.min.css">
		<script type="text/javascript">
			window.TEMPLATE_OPTIONS = {"includeDate":true,"dateFormat":"Do MMM YYYY","systemName":"Merjent Fulcrum Tools","systemSummary":"Version 0.5.8","systemLogo":"","systemColor":"","navMembers":[{"kind":"module","title":"Modules","summary":"All documented modules."},{"kind":"class","title":"Classes","summary":"All documented classes. View inheritance chains in each class description."},{"kind":"external","title":"Externals","summary":"All documented external members."},{"kind":"global","title":"Globals","summary":"All documented globals."},{"kind":"mixin","title":"Mixins","summary":"All documented mixins."},{"kind":"interface","title":"Interfaces","summary":"All documented interfaces."},{"kind":"namespace","title":"Namespaces","summary":"All documented namespaces."},{"kind":"tutorial","title":"Tutorials","summary":"All available tutorials."}],"footer":"","copyright":"Mtools Copyright © 2025 Mikel Paiva","linenums":true,"collapseSymbols":true,"inverseNav":true,"inlineNav":false,"outputSourceFiles":false,"sourceRootPath":null,"disablePackagePath":true,"outputSourcePath":false,"showTableOfContents":true,"showAccessFilter":true,"analytics":null,"methodHeadingReturns":true,"sort":"lineage, longname","search":true,"favicon":null,"stylesheets":[],"scripts":[],"monospaceLinks":false,"cleverLinks":true,"default":{"outputSourceFiles":false}};
			window.DOCLET_TOC_ENABLED = false;
			window.DOCLET_AFILTER_ENABLED = false;
		</script>
</head>
<body>
	<!-- start:navbar.hbs -->
	<header class="navbar navbar-default navbar-fixed-top navbar-inverse">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">
					Merjent Fulcrum Tools
				</a>
				<!-- displayed on small devices -->
				<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="navbar-collapse collapse" id="topNavigation">
				<ul class="nav navbar-nav">
								<li class="dropdown">
									<a href="list_class.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="DataEventHelpers.html">DataEventHelpers</a></li>
											<li><a href="FieldHelpers.html">FieldHelpers</a></li>
											<li><a href="FieldHelpers.MfldColl.html">FieldHelpers.MfldColl</a></li>
											<li><a href="FieldHelpers.MfldTypes.html">FieldHelpers.MfldTypes</a></li>
											<li><a href="FulcrumHelpers.html">FulcrumHelpers</a></li>
											<li><a href="MerjentApp.html">MerjentApp</a></li>
											<li><a href="Mfld.html">Mfld</a></li>
											<li><a href="MLoadRecords.html">MLoadRecords</a></li>
											<li><a href="PhotoDirHandler.html">PhotoDirHandler</a></li>
											<li><a href="ReportHelpers.html">ReportHelpers</a></li>
											<li><a href="ReportHelpers.SecOpt.html">ReportHelpers.SecOpt</a></li>
											<li><a href="RequestHelpers.html">RequestHelpers</a></li>
											<li><a href="Utils.html">Utils</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_module.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="module-MtoolsDataEvents.html">MtoolsDataEvents</a></li>
											<li><a href="module-MtoolsMerjentApp.html">MtoolsMerjentApp</a></li>
											<li><a href="module-MtoolsReports.html">MtoolsReports</a></li>
											<li><a href="module-MtoolsUtils.html">MtoolsUtils</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_namespace.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="DefaultTemplate.html">DefaultTemplate</a></li>
											<li><a href="LockingMixins.html">LockingMixins</a></li>
											<li><a href="PermissionMixins.html">PermissionMixins</a></li>
											<li><a href="PhotoMixins.html">PhotoMixins</a></li>
											<li><a href="StatusMixins.html">StatusMixins</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_tutorial.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="tutorial-CHANGELOG.html">CHANGELOG</a></li>
											<li><a href="tutorial-01_overview.html">01_overview</a></li>
											<li><a href="tutorial-02_5_mloadrecords.html">02_5_mloadrecords</a></li>
											<li><a href="tutorial-02_mtools.html">02_mtools</a></li>
											<li><a href="tutorial-03_mapp.html">03_mapp</a></li>
											<li><a href="tutorial-04_pdf-reports.html">04_pdf-reports</a></li>
											<li><a href="tutorial-06_merjent-dev.html">06_merjent-dev</a></li>
											<li><a href="tutorial-07_general-dev.html">07_general-dev</a></li>
											<li><a href="tutorial-08_mapp-cheat-sheet.html">08_mapp-cheat-sheet</a></li>
									</ul>
								</li>
				</ul>
					<!-- start:lunr-search-navbar.hbs -->
					<form class="navbar-form navbar-right" role="search">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="Search" id="lunr-search-input">
							<div class="input-group-btn">
								<button class="btn btn-default" id="lunr-search-submit">
									<i class="glyphicon glyphicon-search"></i>
								</button>
							</div>
						</div>
					</form>
					<!-- start:lunr-search-navbar.hbs -->		</div>
		</div>
	</header>
	<!-- end:navbar.hbs -->		<div class="page-header">
			<div class="container">
				<span class="kind">source</span>
				<h1><span class="name">Mtools/DataEventHelpers.js</span></h1>
			</div>
		</div>
	<div class="container content">
		<div class="row">
			<div class="col-md-12 main-content">
		<section class="source-section">
			<article></article>
			<pre class="prettyprint source language-javascript line-numbers"><code class="language-javascript">import {RequestHelpers } from './RequestHelpers';
//#region *****************************  DATA EVENT HELPERS **********************************/
/**
 * @class DataEventHelpers
 * @extends RequestHelpers
 * @summary Boilerplate methods common in Merjent apps
 * @description Provides methods for weather data, fire danger ratings, and other common data event tasks.
 *
 * **Inheritance:** Utils → FulcrumHelpers → RequestHelpers → **DataEventHelpers**
 *
 * This is the top-level class used by the Mtools singleton in data event modules.
 *
 * **Inherited Methods:**
 * - All {@link Utils} utility methods (see Utils documentation)
 * - All {@link FulcrumHelpers} Fulcrum-specific methods (see FulcrumHelpers documentation)
 * - All {@link RequestHelpers} HTTP request methods (see RequestHelpers documentation)
 *
 * **Methods Defined in This Class:** Only data event-specific methods are documented below.
 */
class DataEventHelpers extends RequestHelpers {
  constructor() {super();}
  /**
   * @description Description placeholder
   *
   * @param {Function} callback - Function to SETVALUE of field in app
   */
  getFireDanger=(callback)=>{
    var options = {
      url: 'https://fsapps.nwcg.gov/psp/arcgis/rest/services/npsg/Fire_Danger/MapServer/0/query?',
      
      qs: {
        outFields: '*',
        geometry: LONGITUDE() + ',' + LATITUDE(),
        geometryType: 'esriGeometryPoint',
        inSR: '4326',
        spatialRel: 'esriSpatialRelIntersects',
        returnGeometry: false,
        outSR: '4326',
        f: 'json'
      }
    }
  
    REQUEST(options, function(error, response, body) {
      if (error) {
        ALERT('Error with request: ' + INSPECT(error));
        // this.checkConnection(error)
      } else {      
        var data = JSON.parse(body);
        if(!data.features.length){
          callback(null)
        }
        if(data.features.length){
          var feature = data.features[0]; 
          var forecast = feature.attributes['FORECAST']
          callback(forecast)
        } 
      }
    });
  };

  /**
   * @description Description placeholder
   *
   * @param {Function} callback - Function to process result from request and enter data into field or variable. Will be passed on to this.getCurrentWeather()
   * @param {Function} [getCurrentWeather=this.getCurrentWeather] - Calls this.getCurrentWeather() to complete data request
   * @returns {void} - Calls this.getCurrentWeather() to complete data request
   */
  getNwsPoint=(callback, getCurrentWeather=this.getCurrentWeather)=>{
    // const location = `${LATITUDE()},${LONGITUDE()}`
    // const weatherUrl = `https://api.weather.gov/points/${location}`
    // var location = ROUND(LATITUDE(),5).toString() + encodeURIComponent(",") + ROUND(LONGITUDE(),5).toString()
    // var urlBase = "https://api.weather.gov/points/"
    // var weatherUrl = urlBase + location
  
    const location = encodeURIComponent(LATITUDE().toString()) + encodeURIComponent(',') + encodeURIComponent(LONGITUDE().toString())
    const weatherUrl = encodeURI('https://api.weather.gov/points/') + location
  
    const options = {
      url: weatherUrl,
      // headers:{
      //   "Accept":"application/geo+json"
      // }
      accept:'application/geo+json'  
    };
    
    
    REQUEST(options, function (error, response, body) {
      if (error) {
        // this.checkConnection(error)
        ALERT('Error with request: ' + INSPECT(error));
      } else {
        var data = JSON.parse(body);
        // // var office = data.properties.gridId
        // // var x = data.properties.gridX
        // // var y = data.properties.gridY
        var city = data.properties.relativeLocation.properties.city
        var st = data.properties.relativeLocation.properties.state
        var loc = city + ', ' + st
        var url = data.properties.forecast
        
        try{
          // var getCurrentWeather = new DataEventBoilerPlates().getCurrentWeather
          getCurrentWeather(url,loc,callback)
        } catch(e){
          ALERT(JSON.stringify(e))
        }
      }
    })
  };
  
  /**
   * @description Description placeholder
   *
   * @param {string} url - passed in from this.getNwsPoint()
   * @param {string} loc - passed in from this.getNwsPoint()
   * @param {Function} callback - passed in from this.getNwsPoint()
   */
  getCurrentWeather=(url,loc,callback)=>{
    //const location = `${LATITUDE()},${LONGITUDE()}`
    //const weatherUrl = `https://api.weather.gov/gridpoints/MKX/38,64/forecast`
  
    const options = {
      url: url,
      // headers:{
      //   'Accept':'application/geo+json'
      // }
      accept:'application/geo+json'  
    };
  
    REQUEST(options, function (error, response, body) {
      if (error) {
        // this.checkConnection(error)
        ALERT('Error with request: ' + INSPECT(error));
      } else {
        var data = JSON.parse(body);
        if(!data.properties){
          callback(null)
        }
        if(data.properties){
          var period = data.properties.periods[0].name
          var forecast = data.properties.periods[0].detailedForecast
          var output = loc + ' (' + period + '): ' + forecast
          callback(output)
        } 
      }
    })
  };

  /**
   * @description Description placeholder
   *
   * @param {Function} callback -Function to process result from request and enter data into field or variable.
   */
  getPlss=(callback)=>{
    var options = {
      url: 'https://gis.blm.gov/arcgis/rest/services/Cadastral/BLM_Natl_PLSS_CadNSDI/MapServer/3/query?',
      
      qs: {
        outFields: '*',
        geometry: LONGITUDE() + ',' + LATITUDE(),
        geometryType: 'esriGeometryPoint',
        inSR: '4326',
        spatialRel: 'esriSpatialRelIntersects',
        returnGeometry: false,
        outSR: '4326',
        f: 'json'
      }
    }
  
    REQUEST(options, function(error, response, body) {
      if (error) {
        // ALERT('Error with request: ' + INSPECT(error));
        this.checkConnection(error)
      } else {      
        var data = JSON.parse(body);
        if(!data){
          callback(null)
        }
        if(data.features.length){
          var feature = data.features[0]; 
          var tno = feature.attributes['TWNSHPNO']
          var tdir = feature.attributes['TWNSHPDIR']
          var rno = feature.attributes['RANGENO']
          var rdir = feature.attributes['RANGEDIR']
          var sec = feature.attributes['FRSTDIVNO']
          var qsec = feature.attributes['QSEC']
          var qqsec = feature.attributes['QQSEC']
          var lot = feature.attributes['GOVLOT']
  
          // var firstdivid = feature.attributes['FRSTDIVID']
          var firstdivtyp = feature.attributes['FRSTDIVTYP']
          var firstdivtxt = feature.attributes['FRSTDIVTXT']
          // var firstdivno = feature.attributes['FRSTDIVNO']
          // var firstdivsuf = feature.attributes['SECDIVSUF']
          var firstdivlab = feature.attributes['FRSTDIVDUP']
  
          // var firstFull = firstdivtyp + ', ' + firstdivtxt + ', ' + firstdivlab
  
          // var secdivid = feature.attributes['SECDIVID']
          var secdivtyp = feature.attributes['SECDIVTYP']
          // var secdivtxt = feature.attributes['SECDIVTXT']
          var secdivno = feature.attributes['SECDIVNO']
          // var secdivsuf = feature.attributes['SECDIVSUF']
          // var secdivnote = feature.attributes['SECDIVNOTE ']
          var secdivlab = feature.attributes['SECDIVLAB']
  
          // var secdivFull = secdivtyp + ', ' + secdivlab
  
          // var survid = feature.attributes['SURVID']
          var survtyp = feature.attributes['SURVTYP']
          var survtyptxt = feature.attributes['SURVTYPTXT']
          // var srvname = feature.attributes['SRVNAME']
          var survno = feature.attributes['SURVNO']
          // var survsuf = feature.attributes['SURVSUF ']
          // var survnote = feature.attributes['SURVNOTE']
          // var survdiv = feature.attributes['SURVDIV']
          var survlab = feature.attributes['SURVLAB']

          var suffix = ''

          if(secdivtyp == 'A'){
            if(secdivno){
              var firstqsec = secdivno.substring(0,2) + ' 1/4' || ''
              var secondqsec = firstqsec != '' ? secdivno.substring(2)  + ' 1/4' : ''
              suffix = `, ${firstqsec} ${secondqsec}`
            }
            if(!secdivno){
              suffix = `, unsurveyed`
            }
          }
          if(secdivtyp == 'L'){
            suffix = `, lot ${secdivno}`
          }
          if(survtyp == 'T'){
            suffix = `, tract ${survno}`
          }

          //FORMAT: T. 29 S., R. 11 W, sec. 33, SE1/4SE1/4
          var legal = `T.${tno} ${tdir}., R.${rno} ${rdir}., sec. ${sec}${suffix}`

          var out = {"tno":tno,"tdir":tdir,"rno":rno,"rdir":rdir,"sec":sec,"legal":legal}
  
          callback(out)
        } 
      }
    });
  }

  /**
   * @description Returns the most recent date from a repeatable field
   *
   * @param {string} repDn - The repeatable field to check for dates
   * @param {string} dtDn - The date field within the repeatable field
   * @returns {string|null} - Returns the most recent date in ISO format or null if no dates are found
   */
  getClosedDateFromRep=(repDn, dtDn)=>{
    var dates = VALUE(repDn) ? REPEATABLEVALUES(VALUE(repDn),dtDn) : [];
    dates.length > 0 ? dates.sort((a,b) => Date.parse(b) - Date.parse(a)) : null
    return VALUE(repDn) &amp;&amp; dates.length > 0 ? dates[0].toISOString() : null;
  }

  /**
   * @description Updates the 'states' field with the choice values from the event
   *
   * @param {Object} event - The event object containing the value with choice_values
   */
  updateMStates(event){
    const sts = event.value &amp;&amp; event.value.choice_values ? event.value.choice_values : []
    sts ? SETVALUE('states',sts) : null
  }

}
//#endregion

export { DataEventHelpers };</code></pre>
		</section>
			</div>
		</div>
	</div>
	<footer>
				<div class="copyright">Mtools Copyright © 2025 Mikel Paiva</div>
			<div class="generated-by">Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on 24th Feb 2026 using the <a href="https://github.com/steveush/foodoc">FooDoc template</a>.</div>
	</footer>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/clipboard.min.js"></script>
	<script src="js/prism.min.js"></script>
	<script src="js/template.min.js"></script>
		<!-- start:lunr-search-modal.hbs -->
		<div class="modal fade" id="lunr-search-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Search results</h4>
					</div>
					<div class="modal-body" id="lunr-search-body">
					</div>
					<div class="modal-footer" id="lunr-search-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div>
		<!-- end:lunr-search-modal.hbs -->		<script src="js/lunr.min.js"></script>
	
</body>
</html>
<!-- end:source.tmpl.hbs -->